const Web3 = require("web3");
const Provider = require("@truffle/hdwallet-provider");

const exec = async () => {
  const user =
    "a48bdef060a2bc8830e0c4d59128c513990667ca553176c5282a602102f50ae0";
  const provider = new Web3.providers.HttpProvider("http://127.0.0.1:7545");
  Web3.providers.HttpProvider.prototype.sendAsync =
    Web3.providers.HttpProvider.prototype.send;
  const localProvider = new Provider({
    privateKeys: [user],
    providerOrUrl: provider,
  });

  const web3 = new Web3(localProvider);
  const accounts = await web3.eth.accounts.privateKeyToAccount(user);

  const storeABI = [
    {
      inputs: [
        {
          internalType: "address",
          name: "",
          type: "address",
        },
      ],
      name: "balances",
      outputs: [
        {
          internalType: "uint256",
          name: "",
          type: "uint256",
        },
      ],
      stateMutability: "view",
      type: "function",
    },
    {
      inputs: [],
      name: "deposit",
      outputs: [],
      stateMutability: "payable",
      type: "function",
    },
    {
      inputs: [],
      name: "getBalance",
      outputs: [
        {
          internalType: "uint256",
          name: "",
          type: "uint256",
        },
      ],
      stateMutability: "view",
      type: "function",
    },
    {
      inputs: [],
      name: "withdraw",
      outputs: [],
      stateMutability: "nonpayable",
      type: "function",
    },
  ];

  const EtherStore = new web3.eth.Contract(
    storeABI,
    "0xA2e53aD230284DD006Ee37A81253c22da61e9564" //deployed EtherStore contract address
  );

  try {
    //before deposit -> user balance
    await web3.eth.getBalance(accounts.address).then(function (balance) {
      console.log(
        "user balances: ",
        web3.utils.fromWei(balance, "ether"),
        "ether"
      );
    });

    //before deposit -> EtherStore balance
    const balance_ether = await EtherStore.methods.getBalance().call();
    console.log(
      "EtherStore contract's balances: ",
      web3.utils.fromWei(balance_ether, "ether"),
      "ether"
    );

    //deposit
    const tx = await EtherStore.methods.deposit().send({
      from: accounts.address,
      value: 2000000000000000000,
    });
    console.log(tx);

    //after deposit -> user balance
    await web3.eth.getBalance(accounts.address).then(function (balance) {
      console.log(
        "user balances: ",
        web3.utils.fromWei(balance, "ether"),
        "ether"
      );
    });

    //after deposit -> EtherStore balance
    const balance = await EtherStore.methods.getBalance().call();
    console.log(
      "EtherStore contract's balances: ",
      web3.utils.fromWei(balance, "ether"),
      "ether"
    );
  } catch (error) {
    console.log(error);
  }
};

exec();
